.. -*-doctest-*-

===================================
ZopeTestCase.zopedoctest.functional
===================================

Patch for bug #98437 - TestBrowser Referer: header set to 'localhost'

https://bugs.launchpad.net/bugs/98437

Add a document which renders the referer.

    >>> self.folder.addDTMLDocument(
    ...     'index_html', file='''\
    ... <html><body>
    ... <dtml-var "REQUEST['HTTP_REFERER']">
    ... <form action="." method="post" id="post"></form>
    ... <form action="." method="get" id="get"></form>
    ... <a href=".">link</a>
    ... </html></body>
    ... ''')
    ''

Open a browser.

    >>> from Products.Five.testbrowser import Browser
    >>> browser = Browser()
    >>> browser.handleErrors = False

Before patching, fresh requests have an invalid referer.

    >>> browser.open(folder.index_html.absolute_url())
    >>> print browser.contents
    <html><body>
    localhost
    <form action="." method="post" id="post"></form>
    <form action="." method="get" id="get"></form>
    <a href=".">link</a>
    </html></body>

Patch the http function.

    >>> from Products.Five import zcml
    >>> from Products.Five import fiveconfigure
    >>> from collective import testcaselayer
    >>> fiveconfigure.debug_mode = True
    >>> zcml.load_config('configure.zcml', package=testcaselayer)
    >>> fiveconfigure.debug_mode = False

A fresh request should have no referer.

    >>> browser.open(folder.index_html.absolute_url())
    >>> print browser.contents
    <html><body>
    <form action="." method="post" id="post"></form>
    <form action="." method="get" id="get"></form>
    <a href=".">link</a>
    </html></body>

Submitting a form via post should have no referer.

    >>> browser.getForm('post').submit()
    >>> print browser.contents
    <html><body>
    <form action="." method="post" id="post"></form>
    <form action="." method="get" id="get"></form>
    <a href=".">link</a>
    </html></body>

Submitting a form via get should have no referer.

    >>> browser.getForm('get').submit()
    >>> print browser.contents
    <html><body>
    <form action="." method="post" id="post"></form>
    <form action="." method="get" id="get"></form>
    <a href=".">link</a>
    </html></body>

Clicking a link should set the referer.

    >>> browser.getLink('link').click()
    >>> print browser.contents
    <html><body>
    http://nohost/test_folder_1_/
    <form action="." method="post" id="post"></form>
    <form action="." method="get" id="get"></form>
    <a href=".">link</a>
    </html></body>

